<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEX Parser Test - Interactive</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        h1, h2, h3, h4 { color: #333; }
        pre { background-color: #f4f4f4; padding: 10px; border: 1px solid #ddd; white-space: pre-wrap; word-wrap: break-word; }
        ul { list-style-type: disc; margin-left: 20px; }
        .error { color: red; font-weight: bold; }
        .loader {
            border: 5px solid #f3f3f3; /* Light grey */
            border-top: 5px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        select { padding: 8px; margin-bottom: 15px; font-size: 1em; }
        #blockContentsDisplay h4 { margin-top: 20px; margin-bottom: 5px; }
        #blockContentsDisplay h4:first-child { margin-top: 0; }
    </style>
    <script src="cex.js"></script>
</head>
<body>
    <h1>CEX Parser Test - Interactive</h1>

    <p>
        Data source:
        <a id="dataSourceUrl" href="https://raw.githubusercontent.com/homermultitext/hmt-archive/refs/heads/master/releases-cex/hmt-current.cex" target="_blank">
            <!-- URL will be set by script -->
        </a>
    </p>

    <h2>Select a Block Label to View:</h2>
    <select id="blockLabelSelect">
        <option value="">-- Loading Labels --</option>
    </select>
    <div id="loadingIndicator" class="loader" style="display: none;"></div>

    <h2>Contents for Selected Label:</h2>
    <div id="blockContentsDisplay">
        <p>Select a block label from the dropdown above to see its contents.</p>
    </div>

    <hr>
    <h3>Collections for Model 'urn:cite2:hmt:datamodels.v1:codexmodel':</h3>
    <ul id="codexModelCollections">
        <li>Loading...</li>
    </ul>

    <hr>
    <h2>Test with local file:</h2>
    <input type="file" id="fileInput" accept=".cex,.txt">
    <p id="localFileStatus"></p>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cexUrl = 'https://raw.githubusercontent.com/homermultitext/hmt-archive/refs/heads/master/releases-cex/hmt-current.cex';
            document.getElementById('dataSourceUrl').href = cexUrl;
            document.getElementById('dataSourceUrl').textContent = cexUrl;

            const blockSelect = document.getElementById('blockLabelSelect');
            const blockContentsDiv = document.getElementById('blockContentsDisplay');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const fileInput = document.getElementById('fileInput');
            const localFileStatusP = document.getElementById('localFileStatus');
            const codexModelCollectionsUl = document.getElementById('codexModelCollections'); // Get ref to new UL

            let currentParser = null;

            const populateBlockLabelMenu = (parserInstance) => {
                blockSelect.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "-- Select a Label --";
                blockSelect.appendChild(defaultOption);

                if (!parserInstance) {
                    defaultOption.textContent = "-- Error loading labels --";
                    return;
                }
                const uniqueLabels = parserInstance.getUniqueBlockLabels().sort();
                if (uniqueLabels.length > 0) {
                    uniqueLabels.forEach(label => {
                        const option = document.createElement('option');
                        option.value = label;
                        option.textContent = label;
                        blockSelect.appendChild(option);
                    });
                } else {
                    blockSelect.innerHTML = '';
                    const noLabelsOption = document.createElement('option');
                    noLabelsOption.value = "";
                    noLabelsOption.disabled = true;
                    noLabelsOption.textContent = "No block labels found.";
                    blockSelect.appendChild(noLabelsOption);
                }
            };

            const displaySelectedBlockContents = (parserInstance, label) => {
                blockContentsDiv.innerHTML = '';
                if (!parserInstance) {
                    blockContentsDiv.innerHTML = '<p class="error">No CEX data loaded.</p>';
                    return;
                }
                if (!label) {
                    blockContentsDiv.innerHTML = '<p>Select a block label to see its contents.</p>';
                    return;
                }
                const contents = parserInstance.getBlockContents(label);
                if (contents.length > 0) {
                    contents.forEach((content, index) => {
                        const heading = document.createElement('h4');
                        heading.textContent = `--- Block ${index + 1} (Label: '${label}') ---`;
                        blockContentsDiv.appendChild(heading);
                        const pre = document.createElement('pre');
                        pre.textContent = content;
                        blockContentsDiv.appendChild(pre);
                    });
                } else {
                    blockContentsDiv.innerHTML = `<p>No content found for block label "${label}".</p>`;
                }
            };

            const displayCodexModelCollections = (parserInstance) => {
                codexModelCollectionsUl.innerHTML = ''; // Clear previous
                if (!parserInstance) {
                     codexModelCollectionsUl.innerHTML = '<li class="error">No CEX data loaded to find collections.</li>';
                    return;
                }
                const targetModel = 'urn:cite2:hmt:datamodels.v1:codexmodel';
                try {
                    const collections = parserInstance.getCollectionsForModel(targetModel);
                    if (collections.length > 0) {
                        collections.forEach(collection => {
                            const li = document.createElement('li');
                            li.textContent = collection;
                            codexModelCollectionsUl.appendChild(li);
                        });
                    } else {
                        codexModelCollectionsUl.innerHTML = `<li>No collections found for model '${targetModel}'.</li>`;
                    }
                } catch (e) {
                    console.error("Error in getCollectionsForModel:", e);
                    codexModelCollectionsUl.innerHTML = `<li class="error">Error processing datamodels: ${e.message}</li>`;
                }
            };

            const handleError = (error, sourceDescription = "data source") => {
                console.error(`CEX Parser Error from ${sourceDescription}:`, error);
                currentParser = null; // Ensure parser is null on error
                blockSelect.innerHTML = `<option value="">-- Error loading labels --</option>`;
                blockContentsDiv.innerHTML = `<p class="error">Error loading/parsing ${sourceDescription}: ${error.message}</p>`;
                if (codexModelCollectionsUl) {
                    codexModelCollectionsUl.innerHTML = `<li class="error">Could not process datamodels due to load error.</li>`;
                }
                localFileStatusP.textContent = `Error: ${error.message}`;
                localFileStatusP.className = 'error';
            };

            async function processDataSource(dataSourcePromise, sourceDescription) {
                if (typeof CEXParser === 'undefined') {
                    handleError(new Error("CEXParser class not loaded."), sourceDescription);
                    loadingIndicator.style.display = 'none';
                    return;
                }

                loadingIndicator.style.display = 'block';
                blockSelect.disabled = true;
                blockSelect.innerHTML = '<option value="">-- Loading Labels --</option>';
                blockContentsDiv.innerHTML = '<p>Loading data...</p>';
                if (codexModelCollectionsUl) codexModelCollectionsUl.innerHTML = '<li>Loading...</li>';
                localFileStatusP.textContent = `Loading from ${sourceDescription}...`;
                localFileStatusP.className = '';

                const parser = new CEXParser();
                try {
                    await dataSourcePromise(parser);
                    currentParser = parser;
                    populateBlockLabelMenu(currentParser);
                    displaySelectedBlockContents(currentParser, ''); // Reset content display
                    displayCodexModelCollections(currentParser); // Display the datamodel query results
                    localFileStatusP.textContent = `Successfully loaded from ${sourceDescription}.`;
                    localFileStatusP.className = '';
                } catch (error) {
                    handleError(error, sourceDescription);
                } finally {
                    loadingIndicator.style.display = 'none';
                    blockSelect.disabled = false;
                }
            }

            blockSelect.addEventListener('change', (event) => {
                const selectedLabel = event.target.value;
                displaySelectedBlockContents(currentParser, selectedLabel);
            });

            fileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    localFileStatusP.textContent = `Processing ${file.name}...`;
                    localFileStatusP.className = '';
                    await processDataSource(
                        (parser) => parser.loadFromFile(file),
                        `local file '${file.name}'`
                    );
                }
            });

            // Initial load from URL
            processDataSource(
                (parser) => parser.loadFromUrl(cexUrl),
                `URL`
            );
        });
    </script>
</body>
</html>